#!/bin/bash

# Diffie-Hellman Parameters (p and g provided)
p="22576738017835080262877843701749634850617615125854087739043526179744140537692546235303394342825099789672187131484809219828578209085434504812205466211809509312646010163420466911624570134938619901325974015691495758199847891029752021861010053488894613765091779498389361717199652203581458235912782404212189980887677364793502291589837490993625733938828495099140606994041074198876998848736729115104379412189526251092416512126001365278039535701527400528124922912992104175307434201957085685227920121496352427569705275331717292691027336085165189528066507004179996186174476800146427478310174828794820885700903184044808658319809"
g="7"

# User's Public Parameters
u="1862248815160624864452746969307427756225736780561474348058445657192067156396837216166615191483934429590331210498304704151661243642900982149693431525054117973531171043686575982434841581600248650534772500520400667287755133724236630470868780558151660992260862969697955980674372156258233060851599070539964315791063141560394767971234148968286666403261703506067767382611205657692152526465932776055696252284079800318950719385224773430780102270640050163268528393407029512341826673150737624755250210905334054353290348103442567048555920841692912719509376392947403612231439945434893304794953892627563753564041545355129442008938"
v="1"

# IV and Encrypted Password
IV="274f98365a892dfe4d7724f5ac659d22"
encrypted_password="193e498a32667d3b517855435216d3a42daa48f7b71598727045907e2d498115"


echo "$u" | xxd -r -p > u.bin
echo "$v" | xxd -r -p > v.bin

# Step 2: Calculate Shared Secret
shared_secret=$(echo -n "$v" | openssl rsautl -decrypt -inkey private_key.pem)
echo -n "$shared_secret" | head -c 16 > shared_secret.bin

# Step 3: Decode IV and Encrypted Password
echo "$IV" | xxd -r -p > iv.bin
echo "$encrypted_password" | xxd -r -p > encrypted_password.bin

# Step 4: Derive AES Key from Shared Secret
head -c 16 shared_secret.bin > aes_key.bin

# Step 5: Decrypt AES CBC Encrypted Password
openssl enc -aes-128-cbc -d \
    -in encrypted_password.bin \
    -K $(cat aes_key.bin | xxd -p) \
    -iv $(cat iv.bin | xxd -p) \
    -out decrypted_password.txt

# Clean up temporary files
rm u.bin v.bin shared_secret.bin iv.bin encrypted_password.bin aes_key.bin

echo "Decrypted password saved to decrypted_password.txt"

